<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - Multi-Model Interface</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: { 50:'#F0F4F9', 100:'#E1E5EA', 500:'#444746', 800:'#1F1F1F', 900:'#131314' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #444746; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-white dark:bg-gemini-900 text-gray-900 dark:text-gray-100 h-[100dvh] overflow-hidden flex flex-col font-sans transition-colors duration-200">

    <div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-gemini-900">
        <div class="loader mb-4"></div>
        <div class="text-sm text-gray-500">Loading AI Interface...</div>
    </div>

    <div id="app" class="flex flex-1 h-full overflow-hidden hidden opacity-0 transition-opacity duration-500">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden glass" onclick="toggleSidebar()"></div>
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-72 bg-gemini-50 dark:bg-[#1E1F20] transform -translate-x-full lg:translate-x-0 lg:flex flex-col transition-transform duration-300 border-r border-gray-200 dark:border-gray-700 h-full">
            <div class="p-4 shrink-0">
                <button onclick="createNewChat()" class="flex items-center gap-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-medium py-3 px-4 rounded-xl w-full hover:shadow-sm transition-all">
                    <span class="text-xl">+</span> New Chat
                </button>
            </div>
            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-history-list"></div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 shrink-0 space-y-2">
                <button onclick="openSettings()" class="flex items-center gap-3 w-full p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg text-sm">
                    ‚öôÔ∏è Settings & Models
                </button>
                <button onclick="toggleDarkMode()" class="flex items-center gap-3 w-full p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg text-sm">
                    üåô Toggle Theme
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full w-full relative">
            <header class="h-14 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between px-4 bg-white dark:bg-gemini-900 shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">‚ò∞</button>
                    <div class="flex flex-col">
                        <h1 class="font-medium text-sm" id="current-chat-title">New Chat</h1>
                        <span id="current-model-display" class="text-[10px] text-gray-500 font-mono"></span>
                    </div>
                </div>
                <button onclick="deleteCurrentChat()" class="text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 p-2 rounded-full">üóëÔ∏è</button>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth pb-32">
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center p-8 opacity-60">
                    <div class="text-6xl mb-4">üß†</div>
                    <h2 class="text-2xl font-semibold mb-2">Select a Mode</h2>
                    <p class="text-sm text-gray-500 max-w-xs mx-auto">Choose a model in settings or start typing below.</p>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent dark:from-gemini-900 dark:via-gemini-900 z-10">
                <div class="max-w-3xl mx-auto w-full">
                    
                    <div class="flex gap-2 mb-2 px-2">
                        <button onclick="setMode('chat')" id="mode-chat" class="text-xs font-bold px-3 py-1 rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300">üí¨ Chat</button>
                        <button onclick="setMode('image')" id="mode-image" class="text-xs font-bold px-3 py-1 rounded-full bg-gray-100 text-gray-500 dark:bg-gray-800">üñºÔ∏è Image Gen</button>
                        <button onclick="setMode('video')" id="mode-video" class="text-xs font-bold px-3 py-1 rounded-full bg-gray-100 text-gray-500 dark:bg-gray-800">üé• Video Gen</button>
                    </div>

                    <div class="relative bg-gemini-50 dark:bg-[#1E1F20] rounded-[2rem] border border-gray-200 dark:border-gray-700 focus-within:ring-2 ring-blue-500/50 shadow-lg">
                        <textarea id="user-input" rows="1" class="w-full bg-transparent p-4 pr-12 outline-none resize-none max-h-32 text-sm" placeholder="Ask anything..." onkeydown="handleEnter(event)" oninput="autoResize(this)"></textarea>
                        <button id="send-btn" onclick="sendMessage()" class="absolute right-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-all disabled:opacity-50">
                            ‚û§
                        </button>
                    </div>
                    <div class="text-center mt-2">
                        <span class="text-[10px] text-gray-400">Powered by OpenRouter Free Tier</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-[#1E1F20] w-full max-w-md rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4">Configuration</h3>
            
            <div class="mb-4">
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">API Key</label>
                <input type="password" id="api-key-input" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-800 border dark:border-gray-600 text-sm" placeholder="sk-or-..." />
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Select Model</label>
                <select id="model-select" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-800 border dark:border-gray-600 text-sm text-gray-800 dark:text-gray-200" onchange="handleModelChange()">
                    </select>
                <input type="text" id="custom-model-input" class="w-full p-2 mt-2 rounded bg-gray-100 dark:bg-gray-800 border dark:border-gray-600 text-sm hidden" placeholder="Enter custom model ID" />
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeSettings()" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- PRESETS & CONFIG ---
        const PRESET_KEY = "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"; // User provided key
        
        const MODELS = [
            { id: "deepseek/deepseek-r1:free", name: "DeepSeek R1 (Default)" },
            { id: "arcee-ai/trinity-large-preview:free", name: "Arcee Trinity Large" },
            { id: "tngtech/deepseek-r1t2-chimera:free", name: "DeepSeek R1t2 Chimera" },
            { id: "z-ai/glm-4.5-air:free", name: "GLM 4.5 Air" },
            { id: "tngtech/deepseek-r1t-chimera:free", name: "DeepSeek R1t Chimera" },
            { id: "stepfun/step-3.5-flash:free", name: "StepFun 3.5 Flash" },
            { id: "nvidia/nemotron-3-nano-30b-a3b:free", name: "Nvidia Nemotron 3" },
            { id: "deepseek/deepseek-r1-0528:free", name: "DeepSeek R1 (0528)" },
            { id: "tngtech/tng-r1t-chimera:free", name: "TNG R1t Chimera" },
            { id: "openai/gpt-oss-120b:free", name: "GPT OSS 120b" },
            { id: "qwen/qwen3-coder:free", name: "Qwen 3 Coder" },
            { id: "upstage/solar-pro-3:free", name: "Solar Pro 3" },
            { id: "custom", name: "‚úçÔ∏è Custom Model ID..." }
        ];

        let state = {
            chats: [],
            currentChatId: null,
            apiKey: PRESET_KEY,
            model: MODELS[0].id,
            mode: 'chat', // chat, image, video
            theme: 'dark'
        };

        // DOM Elements
        const els = {
            app: document.getElementById('app'),
            loader: document.getElementById('loading'),
            chatContainer: document.getElementById('chat-container'),
            chatList: document.getElementById('chat-history-list'),
            input: document.getElementById('user-input'),
            modelSelect: document.getElementById('model-select'),
            customModelInput: document.getElementById('custom-model-input'),
            apiKeyInput: document.getElementById('api-key-input'),
            settingsModal: document.getElementById('settings-modal'),
            currentModelDisplay: document.getElementById('current-model-display')
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            applyTheme();
            renderChatList();
            populateModelSelect();
            
            marked.setOptions({
                highlight: (code, lang) => highlight.highlight(code, { language: highlight.getLanguage(lang) ? lang : 'plaintext' }).value
            });

            setTimeout(() => {
                els.loader.style.display = 'none';
                els.app.classList.remove('hidden');
                setTimeout(() => els.app.classList.remove('opacity-0'), 100);
                if(state.chats.length === 0) createNewChat();
                else loadChat(state.chats[0].id);
            }, 500);
        });

        // --- STATE & SETTINGS ---
        function saveState() {
            localStorage.setItem('univ_ai_state', JSON.stringify(state));
            updateUI();
        }

        function loadState() {
            const saved = localStorage.getItem('univ_ai_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                // Ensure API key is preserved if user cleared it by accident
                if(!state.apiKey) state.apiKey = PRESET_KEY;
            }
        }

        function populateModelSelect() {
            els.modelSelect.innerHTML = '';
            MODELS.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.text = m.name;
                opt.selected = state.model === m.id;
                els.modelSelect.appendChild(opt);
            });
            handleModelChange(); // Check if custom is needed
        }

        function handleModelChange() {
            const val = els.modelSelect.value;
            if (val === 'custom') {
                els.customModelInput.classList.remove('hidden');
            } else {
                els.customModelInput.classList.add('hidden');
                state.model = val;
            }
        }

        function openSettings() {
            els.apiKeyInput.value = state.apiKey;
            els.modelSelect.value = MODELS.find(m => m.id === state.model) ? state.model : 'custom';
            if(els.modelSelect.value === 'custom') els.customModelInput.value = state.model;
            handleModelChange();
            els.settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            els.settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            state.apiKey = els.apiKeyInput.value.trim();
            if (els.modelSelect.value === 'custom') {
                state.model = els.customModelInput.value.trim();
            } else {
                state.model = els.modelSelect.value;
            }
            saveState();
            closeSettings();
        }

        function updateUI() {
            els.currentModelDisplay.innerText = `${state.mode.toUpperCase()} MODE ‚Ä¢ ${state.model.split('/')[1] || state.model}`;
            applyTheme();
        }

        function toggleDarkMode() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            saveState();
        }

        function applyTheme() {
            document.documentElement.className = state.theme;
        }

        function setMode(mode) {
            state.mode = mode;
            // Update buttons visually
            ['chat', 'image', 'video'].forEach(m => {
                const btn = document.getElementById(`mode-${m}`);
                if (m === mode) {
                    btn.className = "text-xs font-bold px-3 py-1 rounded-full bg-blue-100 text-blue-600 dark:bg-blue-600 dark:text-white transition-colors";
                } else {
                    btn.className = "text-xs font-bold px-3 py-1 rounded-full bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors";
                }
            });
            updateUI();
        }

        // --- CHAT LOGIC ---
        function createNewChat() {
            const chat = { id: Date.now().toString(), title: 'New Chat', messages: [] };
            state.chats.unshift(chat);
            saveState();
            renderChatList();
            loadChat(chat.id);
            toggleSidebar(false);
        }

        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            if (!chat) return;
            
            document.getElementById('current-chat-title').innerText = chat.title;
            els.chatContainer.innerHTML = '';
            
            if (chat.messages.length === 0) {
                document.getElementById('empty-state').style.display = 'flex';
                els.chatContainer.appendChild(document.getElementById('empty-state'));
            } else {
                document.getElementById('empty-state').style.display = 'none';
                chat.messages.forEach(m => appendMessage(m.role, m.content));
            }
            
            renderChatList();
            updateUI();
        }

        function renderChatList() {
            els.chatList.innerHTML = '';
            state.chats.forEach(c => {
                const active = c.id === state.currentChatId;
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-3 rounded-lg text-sm truncate ${active ? 'bg-gray-200 dark:bg-gray-800 font-bold' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}`;
                btn.innerText = c.title;
                btn.onclick = () => loadChat(c.id);
                els.chatList.appendChild(btn);
            });
        }

        function appendMessage(role, content) {
            document.getElementById('empty-state').style.display = 'none';
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex w-full mb-4 ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = isUser 
                ? 'bg-gray-100 dark:bg-[#2A2B2E] p-3 rounded-2xl rounded-tr-sm text-sm max-w-[85%]'
                : 'prose dark:prose-invert max-w-none text-sm w-full pl-2 leading-relaxed';

            div.innerHTML = `
                <div class="${bubble}">
                    ${isUser ? content : marked.parse(content)}
                </div>
            `;
            els.chatContainer.appendChild(div);
            
            // Syntax highlight
            if(!isUser) div.querySelectorAll('pre code').forEach(b => highlight.highlightElement(b));
            
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
            return div;
        }

        async function sendMessage() {
            const text = els.input.value.trim();
            if (!text) return;
            
            els.input.value = '';
            els.input.style.height = 'auto';
            
            // Add user message
            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role: 'user', content: text });
            appendMessage('user', text);
            
            // Update Title
            if (chat.messages.length === 1) {
                chat.title = text.slice(0, 30);
                document.getElementById('current-chat-title').innerText = chat.title;
                renderChatList();
            }

            // Prepare System Prompt based on Mode
            let systemPrompt = "You are a helpful AI assistant.";
            if (state.mode === 'image') {
                systemPrompt = "You are an expert Image Generation Prompt Engineer. The user wants an image. Do not talk significantly. Output a highly detailed, descriptive Stable Diffusion/Midjourney prompt block for the user's request. Start with 'Generate an image of...'";
            } else if (state.mode === 'video') {
                systemPrompt = "You are an expert Video Generation Prompt Engineer. The user wants a video. Output a highly detailed description of camera angles, movement, lighting, and scene action for a video generation model.";
            }

            // Create placeholder for AI
            const aiDiv = appendMessage('assistant', '<span class="animate-pulse">Thinking...</span>');
            const aiContent = aiDiv.querySelector('.prose');
            let fullResponse = "";

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [{ role: "system", content: systemPrompt }, ...chat.messages],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                aiContent.innerHTML = ""; // Clear loader

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.replace('data: ', ''));
                                const delta = json.choices[0]?.delta?.content || "";
                                fullResponse += delta;
                                aiContent.innerHTML = marked.parse(fullResponse);
                            } catch (e) {}
                        }
                    }
                    els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
                }

                chat.messages.push({ role: 'assistant', content: fullResponse });
                saveState();
                aiContent.querySelectorAll('pre code').forEach(b => highlight.highlightElement(b));

            } catch (err) {
                aiContent.innerHTML = `<span class="text-red-500">Error: ${err.message}</span>`;
            }
        }

        // Utils
        function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function deleteCurrentChat() {
            if(confirm('Delete this chat?')) {
                state.chats = state.chats.filter(c => c.id !== state.currentChatId);
                if(state.chats.length === 0) createNewChat();
                else loadChat(state.chats[0].id);
                saveState();
            }
        }
        function toggleSidebar(force) {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            const isHidden = sb.classList.contains('-translate-x-full');
            const show = force !== undefined ? force : isHidden;
            if(show) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        }
    </script>
</body>
</html>
