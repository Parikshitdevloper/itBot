<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AETHER | Secured Configuration</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                extend: {
                    colors: { background: "#050505", glass: "rgba(20, 20, 25, 0.75)" },
                    animation: { 'pulse-glow': 'pulse-glow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 20px rgba(59, 130, 246, 0.1)' },
                            '50%': { opacity: .8, boxShadow: '0 0 40px rgba(139, 92, 246, 0.3)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #e2e8f0; overflow: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .glass-panel {
            background: rgba(18, 18, 20, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .modal-backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .prose pre { background: #0d0d10 !important; border: 1px solid #2a2a30; border-radius: 0.75rem; }
    </style>
</head>
<body class="antialiased selection:bg-blue-500/30 selection:text-white">

    <canvas id="canvas-bg"></canvas>

    <div id="app" class="relative z-10 flex h-[100dvh]">
        
        <aside class="hidden lg:flex flex-col w-80 h-full p-4 gap-4">
            <div class="glass-panel h-full rounded-3xl flex flex-col overflow-hidden">
                <div class="p-6 border-b border-white/5">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 shadow-lg shadow-blue-500/30"></div>
                        <span class="font-bold text-lg tracking-wide">AETHER</span>
                    </div>
                    <button onclick="createNewChat()" class="w-full py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 transition-all flex items-center justify-center gap-2 group">
                        <span class="text-xl font-light group-hover:scale-110 transition-transform">+</span>
                        <span class="text-sm font-medium">New Session</span>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-3 space-y-1" id="sidebar-history"></div>
                <div class="p-4 border-t border-white/5 bg-black/20">
                    <button onclick="triggerAuth()" class="w-full py-2 flex items-center justify-center gap-2 text-gray-400 hover:text-white transition-colors text-sm font-mono border border-white/5 rounded-lg hover:bg-white/5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        CONFIGURE AI
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative p-0 lg:p-4 pl-0">
            <div class="flex-1 glass-panel rounded-none lg:rounded-3xl flex flex-col overflow-hidden relative shadow-2xl">
                <header class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-white/5 backdrop-blur-xl shrink-0 z-20">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleMobileSidebar()" class="lg:hidden text-white/70 hover:text-white">☰</button>
                        <div>
                            <h2 id="current-chat-title" class="text-sm font-bold text-gray-200">New Session</h2>
                            <span class="text-[10px] text-gray-500 font-mono uppercase" id="current-model-label">Loading...</span>
                        </div>
                    </div>
                </header>

                <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth relative">
                    <div id="intro-state" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-100">
                        <div class="w-32 h-32 bg-gradient-to-tr from-blue-500/20 to-purple-500/20 rounded-full blur-3xl absolute animate-pulse-glow"></div>
                        <h1 class="text-3xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-500 relative z-10">System Online</h1>
                    </div>
                </div>

                <div class="p-4 lg:p-6 relative z-30">
                    <div class="relative bg-[#0b0b0d] rounded-2xl flex items-end p-2 border border-white/10 focus-within:border-blue-500/50 transition-colors">
                        <textarea id="user-input" rows="1" class="w-full bg-transparent text-gray-100 p-3 pl-4 outline-none resize-none max-h-40 placeholder-gray-600 font-sans text-[15px]" placeholder="Type a message..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                        <button id="send-btn" onclick="sendMessage()" class="p-3 mb-0.5 mr-0.5 rounded-xl bg-white text-black hover:bg-blue-50 transition-colors">➤</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="auth-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-8 transform scale-95 opacity-0 transition-all duration-300" id="auth-content">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-red-500/20 text-red-400 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-white">Security Check</h3>
                <p class="text-xs text-gray-500 mt-1">Enter admin password to configure AI.</p>
            </div>
            <input type="password" id="auth-pass" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white text-center tracking-widest outline-none focus:border-red-500/50 mb-4" placeholder="••••••••">
            <div class="flex gap-2">
                <button onclick="closeAuth()" class="flex-1 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-sm text-gray-400">Cancel</button>
                <button onclick="checkPassword()" class="flex-1 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-sm text-white font-bold shadow-lg shadow-red-600/20">Unlock</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 transform scale-95 opacity-0 transition-all duration-300" id="settings-content">
            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="text-blue-400">⚙️</span> Core Configuration
                </h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-white">✕</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-blue-400 mb-1 uppercase tracking-wider">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-sm text-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all placeholder-gray-700" placeholder="sk-or-..." />
                </div>

                <div>
                    <label class="block text-xs font-bold text-purple-400 mb-1 uppercase tracking-wider">Model ID</label>
                    <input type="text" id="model-input" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-sm text-gray-300 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition-all" placeholder="deepseek/deepseek-r1:free" />
                    <p class="text-[10px] text-gray-600 mt-1">Example: deepseek/deepseek-r1:free</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-green-400 mb-1 uppercase tracking-wider">System Prompt</label>
                    <textarea id="system-prompt-input" rows="3" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-sm text-gray-300 focus:border-green-500 outline-none transition-all" placeholder="You are a helpful AI..."></textarea>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button onclick="saveSettings()" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-500/20 transition-all transform active:scale-95">
                    Save Configuration
                </button>
            </div>
        </div>
    </div>

    <div id="mobile-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden lg:hidden" onclick="toggleMobileSidebar()"></div>
    <aside id="mobile-sidebar" class="fixed inset-y-0 left-0 w-72 bg-[#121214] z-50 transform -translate-x-full transition-transform duration-300 lg:hidden flex flex-col border-r border-white/10">
        <div class="p-4 border-b border-white/10 flex justify-between items-center">
            <h2 class="font-bold text-xl text-white">Menu</h2>
            <button onclick="triggerAuth()" class="text-xs border border-white/20 px-2 py-1 rounded">Settings</button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="mobile-history-list"></div>
    </aside>

    <script>
        const DEFAULT_MODEL = 'deepseek/deepseek-r1:free';
        const DEFAULT_SYSTEM = 'You are a helpful AI assistant. Answer efficiently using Markdown.';
        
        // This is a placeholder default key (User's previous key). 
        // User can overwrite it in settings.
        const PRESET_KEY = "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";

        let state = {
            chats: [],
            currentChatId: null,
            apiKey: PRESET_KEY,
            model: DEFAULT_MODEL,
            systemPrompt: DEFAULT_SYSTEM,
            isGenerating: false
        };

        const els = {
            app: document.getElementById('app'),
            chatContainer: document.getElementById('chat-container'),
            input: document.getElementById('user-input'),
            chatTitle: document.getElementById('current-chat-title'),
            modelLabel: document.getElementById('current-model-label'),
            intro: document.getElementById('intro-state'),
            authModal: document.getElementById('auth-modal'),
            authContent: document.getElementById('auth-content'),
            authPass: document.getElementById('auth-pass'),
            settingsModal: document.getElementById('settings-modal'),
            settingsContent: document.getElementById('settings-content'),
            inputs: {
                apiKey: document.getElementById('api-key-input'),
                model: document.getElementById('model-input'),
                systemPrompt: document.getElementById('system-prompt-input')
            }
        };

        // --- INIT ---
        window.onload = () => {
            loadState();
            initParticles();
            marked.setOptions({ highlight: (code, lang) => highlight.highlight(code, { language: highlight.getLanguage(lang) ? lang : 'plaintext' }).value });
            
            if (state.chats.length === 0) createNewChat();
            else loadChat(state.chats[0].id);
            
            updateUI();
        };

        // --- AUTH & SETTINGS LOGIC ---
        function triggerAuth() {
            els.authPass.value = '';
            els.authModal.classList.remove('hidden');
            setTimeout(() => {
                els.authContent.classList.remove('scale-95', 'opacity-0');
                els.authContent.classList.add('scale-100', 'opacity-100');
                els.authPass.focus();
            }, 10);
        }

        function closeAuth() {
            els.authContent.classList.remove('scale-100', 'opacity-100');
            els.authContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => els.authModal.classList.add('hidden'), 300);
        }

        function checkPassword() {
            if (els.authPass.value === "Pappu@111") {
                closeAuth();
                openSettings();
            } else {
                els.authPass.classList.add('border-red-500');
                els.authPass.classList.add('animate-pulse');
                setTimeout(() => els.authPass.classList.remove('animate-pulse'), 500);
            }
        }

        function openSettings() {
            els.inputs.apiKey.value = state.apiKey;
            els.inputs.model.value = state.model;
            els.inputs.systemPrompt.value = state.systemPrompt;
            
            els.settingsModal.classList.remove('hidden');
            setTimeout(() => {
                els.settingsContent.classList.remove('scale-95', 'opacity-0');
                els.settingsContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeSettings() {
            els.settingsContent.classList.remove('scale-100', 'opacity-100');
            els.settingsContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => els.settingsModal.classList.add('hidden'), 300);
        }

        function saveSettings() {
            state.apiKey = els.inputs.apiKey.value.trim();
            state.model = els.inputs.model.value.trim() || DEFAULT_MODEL;
            state.systemPrompt = els.inputs.systemPrompt.value.trim() || DEFAULT_SYSTEM;
            saveState();
            closeSettings();
            updateUI();
            alert("Configuration Saved Securely.");
        }

        // --- CORE LOGIC ---
        function saveState() { localStorage.setItem('aether_v2_state', JSON.stringify(state)); }
        function loadState() {
            const saved = localStorage.getItem('aether_v2_state');
            if (saved) state = { ...state, ...JSON.parse(saved) };
        }
        function updateUI() { els.modelLabel.innerText = state.model; }

        function createNewChat() {
            const chat = { id: Date.now().toString(), title: "New Session", messages: [] };
            state.chats.unshift(chat);
            saveState();
            loadChat(chat.id);
            renderHistory();
        }

        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            els.chatTitle.innerText = chat.title;
            els.chatContainer.innerHTML = '';
            
            if(chat.messages.length === 0) {
                els.chatContainer.appendChild(els.intro);
                els.intro.style.opacity = '1';
            } else {
                els.intro.style.opacity = '0';
                chat.messages.forEach(m => appendMessage(m.role, m.content));
            }
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('sidebar-history');
            const mobileList = document.getElementById('mobile-history-list');
            const html = state.chats.map(c => `
                <button onclick="loadChat('${c.id}')" class="w-full text-left p-3 rounded-lg text-xs font-medium transition-all ${c.id === state.currentChatId ? 'bg-blue-500/10 text-blue-400 border border-blue-500/20' : 'text-gray-400 hover:bg-white/5'}">
                    ${c.title}
                </button>
            `).join('');
            list.innerHTML = html;
            mobileList.innerHTML = html;
        }

        function appendMessage(role, content) {
            els.intro.style.opacity = '0';
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-slide-up mb-6`;
            
            const bubble = isUser 
                ? 'bg-white text-black ml-12 rounded-2xl rounded-tr-sm' 
                : 'glass-panel text-gray-200 mr-12 rounded-2xl rounded-tl-sm border-white/10';

            div.innerHTML = `
                <div class="flex flex-col max-w-3xl ${isUser ? 'items-end' : 'items-start'}">
                    <div class="p-4 shadow-lg ${bubble} text-sm leading-relaxed overflow-hidden">
                        <div class="prose prose-invert prose-sm max-w-none">
                            ${isUser ? content : marked.parse(content)}
                        </div>
                    </div>
                </div>
            `;
            els.chatContainer.appendChild(div);
            if(!isUser) div.querySelectorAll('pre code').forEach(b => highlight.highlightElement(b));
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
            return div;
        }

        async function sendMessage() {
            const text = els.input.value.trim();
            if(!text || state.isGenerating) return;

            els.input.value = '';
            els.input.style.height = 'auto';
            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role: 'user', content: text });
            appendMessage('user', text);
            if(chat.messages.length === 1) {
                chat.title = text.slice(0, 30);
                renderHistory();
            }

            state.isGenerating = true;
            const aiDiv = appendMessage('assistant', '<span class="animate-pulse text-blue-400">Thinking...</span>');
            const contentContainer = aiDiv.querySelector('.prose');
            let fullResponse = "";

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [{ role: "system", content: state.systemPrompt }, ...chat.messages],
                        stream: true
                    })
                });

                if(!response.ok) throw new Error(await response.text());

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                contentContainer.innerHTML = "";

                while(true) {
                    const { done, value } = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split("\n");
                    for(const line of lines) {
                        if(line.startsWith("data: ")) {
                            try {
                                const json = JSON.parse(line.replace("data: ", ""));
                                const delta = json.choices[0]?.delta?.content || "";
                                fullResponse += delta;
                                contentContainer.innerHTML = marked.parse(fullResponse);
                            } catch(e){}
                        }
                    }
                    els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
                }
                chat.messages.push({ role: 'assistant', content: fullResponse });
                saveState();
                contentContainer.querySelectorAll('pre code').forEach(b => highlight.highlightElement(b));
            } catch(e) {
                contentContainer.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
            } finally {
                state.isGenerating = false;
            }
        }

        function handleEnter(e) { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }}
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function toggleMobileSidebar() {
            const sb = document.getElementById('mobile-sidebar');
            const ov = document.getElementById('mobile-overlay');
            if(sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        }

        // Particles
        function initParticles() {
            const canvas = document.getElementById('canvas-bg');
            const ctx = canvas.getContext('2d');
            const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
            window.onresize = resize; resize();
            let particles = Array.from({length: 40}, () => ({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3, size: Math.random()*2
            }));
            function animate() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach(p => {
                    p.x+=p.vx; p.y+=p.vy;
                    if(p.x<0||p.x>canvas.width) p.vx*=-1; if(p.y<0||p.y>canvas.height) p.vy*=-1;
                    ctx.fillStyle=`rgba(100,150,255,0.2)`; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
                });
                particles.forEach((a,i) => {
                    particles.slice(i+1).forEach(b => {
                        const d = Math.hypot(a.x-b.x, a.y-b.y);
                        if(d<150) { ctx.strokeStyle=`rgba(100,150,255,${0.1-d/1500})`; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
                    });
                });
                requestAnimationFrame(animate);
            }
            animate();
        }
    </script>
</body>
</html>
